<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no, viewport-fit=cover">
    <title>å•é¡Œé›†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --sidebar-width: 300px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
            /* iOSã®ãƒ†ã‚­ã‚¹ãƒˆè‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´ã‚’æŠ‘åˆ¶ */
        }

        body {
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
        }

        /* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€  */
        .main-wrapper {
            display: flex;
            flex: 1;
            width: 100vw;
            height: 100%;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        /* PCç‰ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« (Desktop only) */
        @media (min-width: 992px) {
            .offcanvas-lg {
                width: var(--sidebar-width) !important;
                border-right: 1px solid #dee2e6;
                visibility: visible !important;
                transform: none !important;
                position: relative !important;
                flex-shrink: 0;
                height: 100% !important;
                display: flex !important;
                flex-direction: column !important;
                background-color: #fff !important;
            }

            .offcanvas-body {
                overflow-y: auto !important;
                flex-grow: 1;
                display: block !important;
            }
        }

        #questionFrame,
        #answerFrame {
            flex: 1;
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            background-color: #fff;
        }

        .page-number {
            display: none !important;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ãƒœã‚¿ãƒ³èª¿æ•´ */
        #questionList .btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            margin-bottom: 2px;
            font-size: 0.9rem;
            white-space: normal;
        }

        .selected-question {
            background-color: yellow !important;
            color: black !important;
        }

        .fav-icon {
            color: #ff4500;
            margin-left: auto;
            font-size: 1.2rem;
            line-height: 1;
            padding-left: 8px;
        }

        .folder-title {
            background-color: #e9ecef;
            padding: 8px;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        #titleQuizStat {
            display: block;
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* å‹•ç”»ã‚’ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å†…ã«åã‚ã‚‹è¨­å®š */
        #modalVideo {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        /* é›»å“ãƒœã‚¿ãƒ³ï¼ˆå›ºå®šï¼‰ */
        #calcToggleBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            z-index: 1060;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 0;
            border: none;
        }

        /* é›»å“UIç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .calculator {
            max-width: 100%;
            width: 300px;
            margin: 0 auto;
            background: #eee;
            padding: 12px;
            border-radius: 12px;
        }

        .calc-display {
            width: 100%;
            height: 60px;
            font-size: 1.8rem;
            text-align: right;
            margin-bottom: 12px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-grid .btn {
            height: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
        }
    </style>
</head>

<body class="bg-light">

    <div class="main-wrapper">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ (Offcanvas-lg) -->
        <div class="offcanvas-lg offcanvas-start bg-white" tabindex="-1" id="offcanvasMenu"
            aria-labelledby="offcanvasMenuLabel">
            <div class="offcanvas-header border-bottom flex-shrink-0">
                <h5 class="offcanvas-title fw-bold" id="offcanvasMenuLabel">å•é¡Œä¸€è¦§</h5>
                <button type="button" class="btn-close d-lg-none" data-bs-dismiss="offcanvas"
                    data-bs-target="#offcanvasMenu" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-2" id="questionList">
                <!-- JSã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <nav class="navbar navbar-expand navbar-dark bg-dark p-2 flex-shrink-0">
                <div class="container-fluid p-0">
                    <button class="btn btn-outline-light me-2 d-lg-none" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasMenu">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="text-white text-truncate flex-grow-1">
                        <div id="currentTitle" class="fw-bold" style="font-size: 0.9rem;">å•é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                        <div id="titleQuizStat"></div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            ãƒ„ãƒ¼ãƒ«
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item" data-bs-toggle="modal"
                                    data-bs-target="#historyModal">å•é¡Œå±¥æ­´</button></li>
                            <li><button class="dropdown-item" data-bs-toggle="modal"
                                    data-bs-target="#videoHistoryModal">å‹•ç”»å±¥æ­´</button></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><button id="reloadBtn" class="dropdown-item">å†èª­ã¿è¾¼ã¿</button></li>
                            <li><button id="clearBtn" class="dropdown-item text-danger">å…¥åŠ›ã‚¯ãƒªã‚¢</button></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><button id="downloadQuizBtn" class="dropdown-item">å›ç­”å±¥æ­´DL</button></li>
                            <li><button id="uploadQuizBtn" class="dropdown-item">å›ç­”å±¥æ­´UP</button></li>
                            <li><button id="downloadBookmarkBtn" class="dropdown-item">ãŠæ°—ã«å…¥ã‚ŠDL</button></li>
                            <li><button id="uploadBookmarkBtn" class="dropdown-item">ãŠæ°—ã«å…¥ã‚ŠUP</button></li>
                            <li><button id="downloadVideoBtn" class="dropdown-item">å‹•ç”»å±¥æ­´DL</button></li>
                            <li><button id="uploadVideoBtn" class="dropdown-item">å‹•ç”»å±¥æ­´UP</button></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- iframe ã‚¨ãƒªã‚¢ -->
            <div class="flex-grow-1 d-flex flex-column overflow-hidden position-relative">
                <!-- åˆæœŸè¡¨ç¤ºç”¨ã®èª¬æ˜ç”»é¢ -->
                <div id="welcomeMessage" class="p-4 overflow-auto bg-white" style="height: 100%;">
                    <div class="container" style="max-width: 800px;">
                        <h2 class="border-bottom pb-2 mb-4">ç°¿è¨˜å•é¡Œé›†ã®ä½¿ã„æ–¹</h2>

                        <div class="mb-4">
                            <h4 class="fw-bold text-primary"><i class="bi bi-list-check me-2"></i>å•é¡Œã®è§£ãæ–¹</h4>
                            <p>å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒãƒ›ã®å ´åˆã¯å·¦ä¸Šã®â‰¡ãƒœã‚¿ãƒ³ï¼‰ã‹ã‚‰å•é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
                                å•é¡ŒãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€å³ä¸‹ã®ã€Œå›ç­”ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ­£è§£ã¨è§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                        </div>

                        <div class="mb-4">
                            <h4 class="fw-bold text-warning"><i class="bi bi-pencil-fill me-2"></i>ä»•è¨³ä¸‹æ›¸ãæ©Ÿèƒ½</h4>
                            <p>ç”»é¢å³ä¸‹ã®é»„è‰²ã„é‰›ç­†ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ä»•è¨³ã®ä¸‹æ›¸ãã‚·ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
                                å‹˜å®šç§‘ç›®ã‚’é¸æŠã—ã€é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ã€å€Ÿæ–¹ãƒ»è²¸æ–¹ã®æ•´ç†ã«æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚<br>
                                é‡‘é¡ã¯è‡ªå‹•çš„ã«ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«ãªã‚Šã€æœ€å¤§10è¡Œã¾ã§å…¥åŠ›å¯èƒ½ã§ã™ã€‚</p>
                        </div>

                        <div class="mb-4">
                            <h4 class="fw-bold text-secondary"><i class="bi bi-calculator me-2"></i>é›»å“æ©Ÿèƒ½</h4>
                            <p>ç”»é¢å³ä¸‹ã®é›»å“ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ç°¡æ˜“é›»å“ãŒä½¿ç”¨ã§ãã¾ã™ã€‚<br>
                                è¨ˆç®—çµæœã‚’ä¸€æ™‚çš„ã«è¡¨ç¤ºã—ã¦ãŠããŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚</p>
                        </div>

                        <div class="mb-4">
                            <h4 class="fw-bold text-success"><i class="bi bi-gear-fill me-2"></i>ãã®ä»–ã®æ©Ÿèƒ½</h4>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item bg-transparent"><i
                                        class="bi bi-bookmark-star-fill text-warning me-2"></i><strong>ãŠæ°—ã«å…¥ã‚Š:</strong>
                                    å•é¡Œåã®æ¨ªã®æ˜Ÿãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã§ãã¾ã™ã€‚</li>
                                <li class="list-group-item bg-transparent"><i
                                        class="bi bi-clock-history me-2"></i><strong>å±¥æ­´:</strong>
                                    ãƒ„ãƒ¼ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€éå»ã®å›ç­”å±¥æ­´ã‚„å‹•ç”»è¦–è´å±¥æ­´ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                                <li class="list-group-item bg-transparent"><i
                                        class="bi bi-youtube text-danger me-2"></i><strong>å‹•ç”»è§£èª¬:</strong>
                                    ä¸€éƒ¨ã®å•é¡Œã«ã¯è§£èª¬å‹•ç”»ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ã‚©ãƒ«ãƒ€åã®æ¨ªã«ã‚ã‚‹ã€Œå‹•ç”»ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¦–è´ã§ãã¾ã™ã€‚</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <iframe id="questionFrame" class="d-none"></iframe>
                <iframe id="answerFrame" class="d-none"></iframe>
            </div>
        </div>
    </div>

    <!-- é›»å“ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
    <button id="calcToggleBtn" class="btn btn-primary" type="button" data-bs-toggle="offcanvas"
        data-bs-target="#calcOffcanvas">
        ğŸ§®
    </button>

    <!-- é›»å“ã‚ªãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div class="offcanvas offcanvas-bottom h-auto" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1"
        id="calcOffcanvas" aria-labelledby="calcOffcanvasLabel">
        <div class="offcanvas-header border-bottom py-2">
            <h6 class="offcanvas-title fw-bold" id="calcOffcanvasLabel">é›»å“</h6>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-2" style="background-color: #f8f9fa;">
            <div class="calculator shadow-sm">
                <input type="text" id="calcDisplay" class="calc-display" readonly value="0">
                <div class="calc-grid">
                    <button class="btn btn-danger" onclick="calcClear()">C</button>
                    <button class="btn btn-secondary" onclick="calcBack()">BS</button>
                    <button class="btn btn-secondary" onclick="calcAppend('/')">Ã·</button>
                    <button class="btn btn-secondary" onclick="calcAppend('*')">Ã—</button>

                    <button class="btn btn-light" onclick="calcAppend('7')">7</button>
                    <button class="btn btn-light" onclick="calcAppend('8')">8</button>
                    <button class="btn btn-light" onclick="calcAppend('9')">9</button>
                    <button class="btn btn-secondary" onclick="calcAppend('-')">-</button>

                    <button class="btn btn-light" onclick="calcAppend('4')">4</button>
                    <button class="btn btn-light" onclick="calcAppend('5')">5</button>
                    <button class="btn btn-light" onclick="calcAppend('6')">6</button>
                    <button class="btn btn-secondary" onclick="calcAppend('+')">+</button>

                    <button class="btn btn-light" onclick="calcAppend('1')">1</button>
                    <button class="btn btn-light" onclick="calcAppend('2')">2</button>
                    <button class="btn btn-light" onclick="calcAppend('3')">3</button>
                    <button class="btn btn-success" onclick="calcEqual()" style="grid-row: span 2;">=</button>

                    <button class="btn btn-light" onclick="calcAppend('0')" style="grid-column: span 2;">0</button>
                    <button class="btn btn-light" onclick="calcAppend('.')">.</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä»•è¨³ãƒœã‚¿ãƒ³ -->
    <button id="journalToggleBtn" class="btn btn-warning" type="button" data-bs-toggle="offcanvas"
        data-bs-target="#journalOffcanvas"
        style="position: fixed; bottom: 84px; right: 20px; width: 54px; height: 54px; border-radius: 50%; z-index: 1060; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; padding: 0; border: none;">
        <i class="bi bi-pencil-fill"></i>
    </button>

    <!-- ä»•è¨³ã‚ªãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div class="offcanvas offcanvas-bottom h-auto" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1"
        id="journalOffcanvas" aria-labelledby="journalOffcanvasLabel">
        <div class="offcanvas-header border-bottom py-2">
            <h6 class="offcanvas-title fw-bold" id="journalOffcanvasLabel">ä»•è¨³ä¸‹æ›¸ã</h6>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0" style="background-color: #fff;">
            <div class="container-fluid p-3">
                <div class="border border-bottom-0">
                    <!-- Header -->
                    <div class="row g-0 bg-secondary text-white text-center py-1 small fw-bold border-bottom">
                        <div class="col-4 border-end">å€Ÿæ–¹ç§‘ç›®</div>
                        <div class="col-2 border-end">é‡‘é¡</div>
                        <div class="col-4 border-end">è²¸æ–¹ç§‘ç›®</div>
                        <div class="col-2">é‡‘é¡</div>
                    </div>
                    <!-- Rows Container -->
                    <div id="journalRowsContainer" style="max-height: 60vh; overflow-y: auto;">
                        <!-- Rows generated by JS -->
                    </div>
                </div>
                <!-- Footer -->
                <div class="p-2 border-top bg-light d-flex justify-content-end">
                    <button class="btn btn-outline-danger btn-sm" onclick="clearJournal()">å…¨ã¦ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
    <input type="file" id="uploadQuizFile" accept="application/json" class="d-none">
    <input type="file" id="uploadBookmarkFile" accept="application/json" class="d-none">
    <input type="file" id="uploadVideoFile" accept="application/json" class="d-none">

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å•é¡Œå±¥æ­´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-1">
                    <div id="historyContainer" class="table-responsive"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="videoHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‹•ç”»å±¥æ­´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-bordered table-striped mb-0" style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>å‹•ç”»</th>
                                <th>å›æ•°</th>
                                <th>æœ€çµ‚</th>
                            </tr>
                        </thead>
                        <tbody id="video-history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">çµæœ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center fs-5" id="resultContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å‹•ç”»ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered">
            <div class="modal-content text-bg-dark border-0">
                <div class="modal-header border-0 pb-0 flex-shrink-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div
                    class="modal-body p-0 d-flex flex-column align-items-center justify-content-center overflow-hidden flex-grow-1">
                    <video id="modalVideo" controls autoplay></video>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const qFrame = document.getElementById("questionFrame");
        const aFrame = document.getElementById("answerFrame");
        const titleEl = document.getElementById("currentTitle");
        const titleStatSpan = document.getElementById("titleQuizStat");
        const historyContainer = document.getElementById("historyContainer");
        const offcanvasEl = document.getElementById("offcanvasMenu");
        let offcanvasInstance;

        let clickedOnce = false;
        let timerInterval = null;
        let elapsedSeconds = 0;

        document.addEventListener("DOMContentLoaded", () => {
            offcanvasInstance = new bootstrap.Offcanvas(offcanvasEl);

            fetch("data.json")
                .then(r => r.json())
                .then(data => buildMenu(data))
                .catch(err => {
                    document.getElementById("questionList").innerHTML = `<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
                });
        });

        // é›»å“ãƒ­ã‚¸ãƒƒã‚¯
        const calcDisplay = document.getElementById("calcDisplay");
        function calcAppend(val) {
            if (calcDisplay.value === "0" && val !== ".") calcDisplay.value = val;
            else calcDisplay.value += val;
        }
        function calcClear() { calcDisplay.value = "0"; }
        function calcBack() {
            calcDisplay.value = calcDisplay.value.slice(0, -1);
            if (calcDisplay.value === "") calcDisplay.value = "0";
        }
        function calcEqual() {
            try {
                const expr = calcDisplay.value.replace(/[^0-9+\-*/.]/g, "");
                calcDisplay.value = eval(expr);
            } catch (e) {
                calcDisplay.value = "Error";
            }
        }

        function buildMenu(data) {
            const list = document.getElementById("questionList");
            list.innerHTML = "";

            for (const [folder, items] of Object.entries(data)) {
                const section = document.createElement("div");
                section.className = "mb-3";

                const titleWrapper = document.createElement("div");
                titleWrapper.className = "folder-title d-flex justify-content-between align-items-center mb-2";
                titleWrapper.innerHTML = `<span>${folder}</span>`;

                let firstVideo = (items || []).find(f => typeof f === "string" && f.toLowerCase().endsWith(".mp4"));
                if (firstVideo) {
                    const vBtn = document.createElement("button");
                    vBtn.className = "btn btn-sm btn-outline-primary video-btn py-0";
                    vBtn.dataset.video = "data/" + firstVideo;
                    vBtn.textContent = "å‹•ç”»";
                    vBtn.onclick = (e) => { e.stopPropagation(); showVideoModal("data/" + firstVideo); };
                    titleWrapper.appendChild(vBtn);
                }
                section.appendChild(titleWrapper);

                const btnGroup = document.createElement("div");
                btnGroup.className = "d-grid gap-1";

                (items || []).forEach(item => {
                    if (typeof item === "string" && !item.toLowerCase().endsWith(".mp4")) {
                        const btn = document.createElement("button");
                        btn.className = "btn btn-light btn-sm text-start border";
                        btn.dataset.file = "data/" + item;

                        // ãƒœã‚¿ãƒ³å†…ã®æ§‹é€ : ãƒ†ã‚­ã‚¹ãƒˆ
                        const spanText = document.createElement("span");
                        spanText.textContent = item.split("/").pop().replace(".html", "");
                        btn.appendChild(spanText);

                        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚¢ã‚¤ã‚³ãƒ³
                        const icon = document.createElement("i");
                        icon.className = "fav-icon bi bi-bookmark-fill";
                        icon.style.display = "none"; // åˆæœŸã¯éè¡¨ç¤º
                        btn.appendChild(icon);

                        btn.onclick = () => {
                            // é¸æŠçŠ¶æ…‹ã®æ›´æ–°
                            document.querySelectorAll("#questionList .btn").forEach(b => b.classList.remove("selected-question"));
                            btn.classList.add("selected-question");

                            document.getElementById("welcomeMessage").classList.add("d-none");
                            qFrame.src = btn.dataset.file;
                            aFrame.classList.add("d-none");
                            qFrame.classList.remove("d-none");
                            titleEl.textContent = spanText.textContent;
                            clickedOnce = false;

                            if (window.innerWidth < 992) {
                                offcanvasInstance.hide();
                            }
                        };
                        btnGroup.appendChild(btn);
                    }
                });

                section.appendChild(btnGroup);
                list.appendChild(section);
            }
            updateMenuHighlight();
            updateVideoButtons();
            updateMenuBookmarks();
        }

        function loadVideoHistory() { return JSON.parse(localStorage.getItem("video_history") || "{}"); }
        function saveVideoHistory(p) {
            const d = loadVideoHistory();
            if (!d[p]) d[p] = { watched: true, count: 0, lastWatched: "" };
            d[p].watched = true; d[p].count++; d[p].lastWatched = new Date().toLocaleString("ja-JP");
            localStorage.setItem("video_history", JSON.stringify(d));
        }
        function updateVideoButtons() {
            const h = loadVideoHistory();
            document.querySelectorAll(".video-btn").forEach(b => {
                if (h[b.dataset.video]?.watched) { b.classList.remove("btn-outline-primary"); b.classList.add("btn-primary"); }
            });
        }

        function showVideoModal(src) {
            saveVideoHistory(src);
            updateVideoButtons();
            let m = document.getElementById("videoModal");
            m.querySelector("video").src = src;
            new bootstrap.Modal(m).show();

            if (!m.dataset.listenerAdded) {
                m.addEventListener("hidden.bs.modal", () => {
                    const v = m.querySelector("video");
                    v.pause();
                    v.src = "";
                });
                m.dataset.listenerAdded = "true";
            }
        }

        function loadResults() { return JSON.parse(localStorage.getItem("quiz_results") || "{}"); }
        function saveResult(file, correct, wrong, timeSec) {
            const d = loadResults();
            if (!d[file]) d[file] = [];
            d[file].unshift({ correct, wrong, rate: Math.round((correct / (correct + wrong || 1)) * 100), time: timeSec, date: new Date().toLocaleString("ja-JP") });
            if (d[file].length > 10) d[file] = d[file].slice(0, 10);
            localStorage.setItem("quiz_results", JSON.stringify(d));
            updateMenuHighlight();
        }

        function updateMenuHighlight() {
            const d = loadResults();
            document.querySelectorAll("#questionList button[data-file]").forEach(b => {
                const f = b.dataset.file.split("/").pop();
                const r = d[f] || [];
                if (r.some(x => x.rate === 100)) b.style.color = "blue";
                else if (r[0]?.wrong > 0) b.style.color = "red";
                else b.style.color = "";
            });
        }

        qFrame.addEventListener("load", () => {
            const doc = qFrame.contentDocument; if (!doc) return;
            const pn = doc.querySelector(".page-number"); if (pn) pn.style.display = "none";
            const btn = doc.querySelector("#btn_Answer, #btn_Answer_Text"); if (!btn) return;

            hideLabels(doc); startTimer(doc);
            btn.textContent = "å›ç­”"; clickedOnce = false;

            const qFile = qFrame.src.split("/").pop();
            const stats = getQuizStats(qFile);
            titleStatSpan.textContent = stats.count > 0 ? `å›ç­”: ${stats.count}å› / å¹³å‡: ${stats.avgRate}%` : "æœªå›ç­”";

            const bookmarkBtn = doc.getElementById("btnElearningBookmark");
            if (bookmarkBtn) {
                const bms = loadBookmarks();
                bookmarkBtn.style.backgroundColor = bms.includes(qFile) ? "yellow" : "";
                bookmarkBtn.onclick = () => {
                    let cur = loadBookmarks();
                    if (cur.includes(qFile)) { cur = cur.filter(x => x !== qFile); bookmarkBtn.style.backgroundColor = ""; }
                    else { cur.push(qFile); bookmarkBtn.style.backgroundColor = "yellow"; }
                    saveBookmarks(cur);
                    updateMenuBookmarks(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®â˜…è¡¨ç¤ºã‚’æ›´æ–°
                };
            }

            btn.onclick = async () => {
                const aFile = qFrame.src.replace(".html", "A.html");
                if (!clickedOnce) {
                    stopTimer();
                    try {
                        const res = await fetch(aFile); const html = await res.text();
                        const ansDoc = new DOMParser().parseFromString(html, "text/html");
                        let c = 0, w = 0;
                        doc.querySelectorAll("input[id],select[id]").forEach(el => {
                            const cel = ansDoc.querySelector(`#${el.id}`); if (!cel) return;
                            const v = (el.value || "").replace(/,/g, "").trim(), target = (cel.value || "").replace(/,/g, "").trim();
                            if (v === "" && target === "") return;
                            if (v === target) { el.style.backgroundColor = "rgba(0,255,0,0.2)"; c++; }
                            else { el.style.backgroundColor = "rgba(255,0,0,0.2)"; w++; }
                        });
                        const rContent = document.getElementById("resultContent");
                        rContent.innerHTML = `<b class="text-success">æ­£è§£:${c}</b> / <b class="text-danger">ä¸æ­£è§£:${w}</b><br><small>æ™‚é–“:${formatTime(elapsedSeconds)}</small>`;
                        new bootstrap.Modal(document.getElementById("resultModal")).show();
                        saveResult(qFile, c, w, elapsedSeconds);
                        btn.textContent = "è§£èª¬"; clickedOnce = true;
                    } catch (e) { alert("æ­£è§£å–å¾—å¤±æ•—: " + e); }
                } else {
                    aFrame.src = aFile; aFrame.onload = () => hideLabels(aFrame.contentDocument, true);
                    qFrame.classList.add("d-none"); aFrame.classList.remove("d-none");
                }
            };
        });

        function hideLabels(doc, isA = false) {
            ["p.cancel#btn_Cancel", "div.result"].forEach(s => { const x = doc.querySelector(s); if (x) x.style.display = "none"; });
            if (isA) { const a = doc.querySelector("h2#btn_Answer"); if (a) a.style.display = "none"; }
        }

        function startTimer(doc) {
            const t = doc.getElementById("v_time_all"); if (!t) return;
            stopTimer(); elapsedSeconds = 0;
            const f = () => t.textContent = formatTime(elapsedSeconds);
            f(); timerInterval = setInterval(() => { elapsedSeconds++; f(); }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function formatTime(s) { return `${Math.floor(s / 60)}åˆ†${String(s % 60).padStart(2, "0")}ç§’`; }

        function loadBookmarks() { return JSON.parse(localStorage.getItem("quiz_bookmarks") || "[]"); }
        function saveBookmarks(b) { localStorage.setItem("quiz_bookmarks", JSON.stringify(b)); }
        function updateMenuBookmarks() {
            // Store bookmarks as a Set of decoded filenames for reliable matching
            const bms = new Set(loadBookmarks().map(b => decodeURIComponent(b)));

            document.querySelectorAll("#questionList button[data-file]").forEach(b => {
                const fStr = b.dataset.file.split("/").pop();
                const fDecoded = decodeURIComponent(fStr);

                const icon = b.querySelector(".fav-icon");
                if (icon) {
                    icon.style.display = bms.has(fDecoded) ? "inline-block" : "none";
                }
            });
        }
        function getQuizStats(f) {
            const d = loadResults()[f] || [];
            if (!d.length) return { count: 0, avgRate: 0 };
            return { count: d.length, avgRate: Math.round(d.reduce((s, r) => s + r.rate, 0) / d.length) };
        }

        document.getElementById("historyModal").addEventListener("show.bs.modal", () => {
            const d = loadResults();
            let h = '<table class="table table-sm table-condensed" style="font-size:0.75rem"><thead><tr><th>å•é¡Œ</th><th>ç‡</th><th>æ™‚é–“</th><th>æ—¥</th></tr></thead><tbody>';
            for (const [f, recs] of Object.entries(d)) {
                recs.forEach(r => { h += `<tr><td>${f.replace('.html', '')}</td><td>${r.rate}%</td><td>${formatTime(r.time)}</td><td>${r.date.split(' ')[0]}</td></tr>`; });
            }
            document.getElementById("historyContainer").innerHTML = h + '</tbody></table>';
        });
        document.getElementById("videoHistoryModal").addEventListener("show.bs.modal", () => {
            const h = loadVideoHistory();
            let row = "";
            for (let t in h) { row += `<tr><td>${t}</td><td>${h[t].count}</td><td>${h[t].lastWatched.split(' ')[0]}</td></tr>`; }
            document.getElementById("video-history-body").innerHTML = row;
        });

        document.getElementById("downloadQuizBtn").onclick = () => downloadJSON("quiz_results.json", loadResults());
        document.getElementById("downloadBookmarkBtn").onclick = () => downloadJSON("quiz_bookmarks.json", loadBookmarks());
        document.getElementById("downloadVideoBtn").onclick = () => downloadJSON("video_history.json", loadVideoHistory());
        function downloadJSON(n, d) {
            const b = new Blob([JSON.stringify(d, null, 2)], { type: "application/json" });
            const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = n; a.click();
        }
        document.getElementById("uploadQuizBtn").onclick = () => document.getElementById("uploadQuizFile").click();
        document.getElementById("uploadBookmarkBtn").onclick = () => document.getElementById("uploadBookmarkFile").click();
        document.getElementById("uploadVideoBtn").onclick = () => document.getElementById("uploadVideoFile").click();
        document.getElementById("uploadQuizFile").onchange = (e) => handleUpload(e.target, "quiz_results", updateMenuHighlight);
        document.getElementById("uploadBookmarkFile").onchange = (e) => handleUpload(e.target, "quiz_bookmarks", updateMenuBookmarks);
        document.getElementById("uploadVideoFile").onchange = (e) => handleUpload(e.target, "video_history", updateVideoButtons);
        async function handleUpload(el, k, cb) {
            const f = el.files[0]; if (!f) return;
            const j = JSON.parse(await f.text()); localStorage.setItem(k, JSON.stringify(j));
            if (cb) cb(); alert("å®Œäº†"); el.value = "";
        }

        document.getElementById("reloadBtn").onclick = () => location.reload();
        document.getElementById("clearBtn").onclick = () => {
            const doc = qFrame.contentDocument; if (!doc) return;
            doc.querySelectorAll("input, select").forEach(el => { el.value = ""; el.style.backgroundColor = ""; });
        };
        // ä»•è¨³æ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯
        const journalAccounts = {
            "è³‡ç”£ (Assets)": [
                "ç¾é‡‘", "æ™®é€šé é‡‘", "å½“åº§é é‡‘", "å£²æ›é‡‘", "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²æ›é‡‘", "å—å–æ‰‹å½¢", "é›»å­è¨˜éŒ²å‚µæ¨©", "æœªåå…¥é‡‘", "æœªååˆ©æ¯", "è²¸ä»˜é‡‘", "æ‰‹å½¢è²¸ä»˜é‡‘", "ä»®æ‰•é‡‘", "ç«‹æ›¿é‡‘", "å‰æ‰•é‡‘", "è²¯è”µå“", "å—å–å•†å“åˆ¸", "å‰æ‰•å®¶è³ƒ", "å‰æ‰•ä¿é™ºæ–™", "ä»®æ‰•æ¶ˆè²»ç¨", "ä»®æ‰•æ³•äººç¨ç­‰", "è²¸å€’å¼•å½“é‡‘",
                "åœŸåœ°", "å»ºç‰©", "å‚™å“", "å·®å…¥ä¿è¨¼é‡‘", "æ¸›ä¾¡å„Ÿå´ç´¯è¨ˆé¡"
            ],
            "è² å‚µ (Liabilities)": [
                "è²·æ›é‡‘", "æ”¯æ‰•æ‰‹å½¢", "æœªæ‰•é‡‘", "å€Ÿå…¥é‡‘", "æ‰‹å½¢å€Ÿå…¥é‡‘", "å½“åº§å€Ÿè¶Š", "å‰å—é‡‘", "é ã‚Šé‡‘", "ä»®å—é‡‘", "å‰å—å®¶è³ƒ", "å‰å—åœ°ä»£", "å‰å—æ‰‹æ•°æ–™", "æœªæ‰•åˆ©æ¯", "æœªæ‰•çµ¦æ–™", "æœªæ‰•é…å½“é‡‘", "æœªæ‰•æ¶ˆè²»ç¨", "æœªæ‰•æ³•äººç¨ç­‰", "ä»®å—æ¶ˆè²»ç¨"
            ],
            "ç´”è³‡ç”£ (Net Assets)": [
                "è³‡æœ¬é‡‘", "åˆ©ç›Šæº–å‚™é‡‘", "ç¹°è¶Šåˆ©ç›Šå‰°ä½™é‡‘"
            ],
            "è²»ç”¨ (Expenses)": [
                "ä»•å…¥", "çµ¦æ–™", "æ³•å®šç¦åˆ©è²»", "æ”¯æ‰•å®¶è³ƒ", "æ”¯æ‰•åœ°ä»£", "æ°´é“å…‰ç†±è²»", "ä¿®ç¹•è²»", "æ¸›ä¾¡å„Ÿå´è²»", "æ¶ˆè€—å“è²»", "ç™ºé€è²»", "æ—…è²»äº¤é€šè²»", "é€šä¿¡è²»", "åºƒå‘Šå®£ä¼è²»", "æ”¯æ‰•æ‰‹æ•°æ–™", "æ”¯æ‰•ä¿é™ºæ–™", "ç§Ÿç¨å…¬èª²", "é›‘è²»", "è²¸å€’å¼•å½“é‡‘ç¹°å…¥",
                "æ”¯æ‰•åˆ©æ¯", "è²¸å€’æå¤±", "å›ºå®šè³‡ç”£å£²å´æ", "é›‘æ", "æ³•äººç¨ã€ä½æ°‘ç¨åŠã³äº‹æ¥­ç¨"
            ],
            "åç›Š (Revenue)": [
                "å£²ä¸Šé«˜", "å£²ä¸Š", "å—å–æ‰‹æ•°æ–™", "å—å–åˆ©æ¯", "å—å–åœ°ä»£", "å›ºå®šè³‡ç”£å£²å´ç›Š", "å„Ÿå´å‚µæ¨©å–ç«‹ç›Š", "é›‘ç›Š"
            ]
        };

        function initJournal() {
            const container = document.getElementById("journalRowsContainer");
            container.innerHTML = "";

            // Create options HTML once
            let optionsHtml = '<option value=""></option>';
            for (const [category, items] of Object.entries(journalAccounts)) {
                optionsHtml += `<optgroup label="${category}">`;
                items.forEach(item => {
                    optionsHtml += `<option value="${item}">${item}</option>`;
                });
                optionsHtml += `</optgroup>`;
            }

            // Generate 10 rows
            for (let i = 0; i < 10; i++) {
                const row = document.createElement("div");
                row.className = "row g-0"; // Removed border-bottom from row to handle it in cells if needed, or keep it.
                // Let's use individual cell borders to ensure a grid look.
                // We'll wrap the whole thing in a border container, so we just need internal borders.

                row.innerHTML = `
                    <div class="col-4 p-2 border-end border-bottom">
                        <select class="form-select form-select-sm journal-select" style="background-color: #fff;">${optionsHtml}</select>
                    </div>
                    <div class="col-2 p-2 border-end border-bottom">
                        <input type="text" class="form-control form-control-sm text-end journal-amount" placeholder="" inputmode="numeric" style="background-color: #fff;">
                    </div>
                    <div class="col-4 p-2 border-end border-bottom">
                        <select class="form-select form-select-sm journal-select" style="background-color: #fff;">${optionsHtml}</select>
                    </div>
                    <div class="col-2 p-2 border-bottom">
                        <input type="text" class="form-control form-control-sm text-end journal-amount" placeholder="" inputmode="numeric" style="background-color: #fff;">
                    </div>
                `;
                container.appendChild(row);
            }

            // Attach event listeners for amount formatting
            document.querySelectorAll(".journal-amount").forEach(input => {
                input.addEventListener("input", (e) => {
                    let val = e.target.value.replace(/,/g, "").replace(/[^0-9]/g, "");
                    e.target.value = val ? new Intl.NumberFormat('en-US').format(val) : "";
                });
            });
        }

        function clearJournal() {
            document.querySelectorAll(".journal-select").forEach(el => el.value = "");
            document.querySelectorAll(".journal-amount").forEach(el => el.value = "");
        }

        initJournal();
    </script>
</body>

</html>