<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂïèÈ°åÈõÜ - PCÁâà</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 300px;
        }

        body {
            height: 100dvh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* ÂÖ±ÈÄö„É¨„Ç§„Ç¢„Ç¶„ÉàÊßãÈÄ† */
        .main-wrapper {
            display: flex;
            height: 100%;
            width: 100%;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            width: 100%;
            /* „É¢„Éê„Ç§„É´„ÅßÂÖ®ÂπÖ„ÇíÁ¢∫‰øù */
        }

        /* PCÁâà„Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É´ (Desktop only) */
        @media (min-width: 992px) {
            .offcanvas-lg {
                width: var(--sidebar-width) !important;
                border-right: 1px solid #dee2e6;
                visibility: visible !important;
                transform: none !important;
                position: relative !important;
                flex-shrink: 0;
                height: 100% !important;
                display: flex !important;
                flex-direction: column !important;
            }

            .offcanvas-body {
                overflow-y: auto !important;
                flex-grow: 1;
                display: block !important;
            }
        }

        #questionFrame,
        #answerFrame {
            flex: 1;
            width: 100%;
            border: none;
        }

        .page-number {
            display: none !important;
        }

        /* „É°„Éã„É•„ÉºÂÜÖ„ÅÆ„Éú„Çø„É≥Ë™øÊï¥ */
        #questionList .btn {
            text-align: left;
            margin-bottom: 2px;
            font-size: 0.9rem;
        }

        .folder-title {
            background-color: #f8f9fa;
            padding: 8px;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        #titleQuizStat {
            display: block;
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* ÂãïÁîª„Çí„Ç¶„Ç£„É≥„Éâ„Ç¶ÂÜÖ„Å´Âèé„ÇÅ„ÇãË®≠ÂÆö */
        #modalVideo {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        #questionList::-webkit-scrollbar {
            width: 6px;
        }

        #questionList::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        /* ÈõªÂçì„Éú„Çø„É≥ÔºàÂõ∫ÂÆöÔºâ */
        #calcToggleBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            z-index: 1050;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* ÈõªÂçìUIÁî®„Çπ„Çø„Ç§„É´ */
        .calculator {
            max-width: 320px;
            margin: 0 auto;
            background: #f4f4f4;
            padding: 10px;
            border-radius: 8px;
        }

        .calc-display {
            width: 100%;
            height: 50px;
            font-size: 1.5rem;
            text-align: right;
            margin-bottom: 10px;
            padding: 5px 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .calc-grid .btn {
            height: 50px;
            font-size: 1.2rem;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-light">

    <div class="main-wrapper">
        <!-- „Çµ„Ç§„Éâ„Éê„Éº (Offcanvas-lg) -->
        <div class="offcanvas-lg offcanvas-start bg-white" tabindex="-1" id="offcanvasMenu"
            aria-labelledby="offcanvasMenuLabel">
            <div class="offcanvas-header border-bottom flex-shrink-0">
                <h5 class="offcanvas-title fw-bold" id="offcanvasMenuLabel">ÂïèÈ°å‰∏ÄË¶ß</h5>
                <button type="button" class="btn-close d-lg-none" data-bs-dismiss="offcanvas"
                    data-bs-target="#offcanvasMenu" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-2" id="questionList">
                <!-- JS„Åß„Ç≥„É≥„ÉÜ„É≥„ÉÑÁîüÊàê -->
            </div>
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="main-content">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark p-2 flex-shrink-0">
                <div class="container-fluid p-0">
                    <button class="btn btn-outline-light me-2 d-lg-none" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasMenu">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="text-white text-truncate flex-grow-1">
                        <div id="currentTitle" class="fw-bold" style="font-size: 0.9rem;">ÂïèÈ°å„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                        <div id="titleQuizStat"></div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            „ÉÑ„Éº„É´
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item" data-bs-toggle="modal"
                                    data-bs-target="#historyModal">ÂïèÈ°åÂ±•Ê≠¥</button></li>
                            <li><button class="dropdown-item" data-bs-toggle="modal"
                                    data-bs-target="#videoHistoryModal">ÂãïÁîªÂ±•Ê≠¥</button></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><button id="reloadBtn" class="dropdown-item">ÂÜçË™≠„ÅøËæº„Åø</button></li>
                            <li><button id="clearBtn" class="dropdown-item text-danger">ÂÖ•Âäõ„ÇØ„É™„Ç¢</button></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><button id="downloadQuizBtn" class="dropdown-item">ÂõûÁ≠îÂ±•Ê≠¥DL</button></li>
                            <li><button id="uploadQuizBtn" class="dropdown-item">ÂõûÁ≠îÂ±•Ê≠¥UP</button></li>
                            <li><button id="downloadVideoBtn" class="dropdown-item">ÂãïÁîªÂ±•Ê≠¥DL</button></li>
                            <li><button id="uploadVideoBtn" class="dropdown-item">ÂãïÁîªÂ±•Ê≠¥UP</button></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- iframe „Ç®„É™„Ç¢ -->
            <div class="flex-grow-1 d-flex flex-column overflow-hidden">
                <iframe id="questionFrame" class="bg-white"></iframe>
                <iframe id="answerFrame" class="bg-white d-none"></iframe>
            </div>
        </div>
    </div>

    <!-- ÈõªÂçì„Éà„Ç∞„É´„Éú„Çø„É≥ -->
    <button id="calcToggleBtn" class="btn btn-primary" type="button" data-bs-toggle="offcanvas"
        data-bs-target="#calcOffcanvas">
        üßÆ
    </button>

    <!-- ÈõªÂçì„Ç™„Éï„Ç≠„É£„É≥„Éê„Çπ -->
    <div class="offcanvas offcanvas-bottom h-auto" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1"
        id="calcOffcanvas" aria-labelledby="calcOffcanvasLabel">
        <div class="offcanvas-header border-bottom py-2">
            <h6 class="offcanvas-title fw-bold" id="calcOffcanvasLabel">ÈõªÂçì</h6>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-2" style="background-color: #f8f9fa;">
            <div class="calculator shadow-sm">
                <input type="text" id="calcDisplay" class="calc-display" readonly value="0">
                <div class="calc-grid">
                    <button class="btn btn-danger" onclick="calcClear()">C</button>
                    <button class="btn btn-secondary" onclick="calcBack()">BS</button>
                    <button class="btn btn-secondary" onclick="calcAppend('/')">√∑</button>
                    <button class="btn btn-secondary" onclick="calcAppend('*')">√ó</button>

                    <button class="btn btn-light" onclick="calcAppend('7')">7</button>
                    <button class="btn btn-light" onclick="calcAppend('8')">8</button>
                    <button class="btn btn-light" onclick="calcAppend('9')">9</button>
                    <button class="btn btn-secondary" onclick="calcAppend('-')">-</button>

                    <button class="btn btn-light" onclick="calcAppend('4')">4</button>
                    <button class="btn btn-light" onclick="calcAppend('5')">5</button>
                    <button class="btn btn-light" onclick="calcAppend('6')">6</button>
                    <button class="btn btn-secondary" onclick="calcAppend('+')">+</button>

                    <button class="btn btn-light" onclick="calcAppend('1')">1</button>
                    <button class="btn btn-light" onclick="calcAppend('2')">2</button>
                    <button class="btn btn-light" onclick="calcAppend('3')">3</button>
                    <button class="btn btn-success" onclick="calcEqual()" style="grid-row: span 2;">=</button>

                    <button class="btn btn-light" onclick="calcAppend('0')" style="grid-column: span 2;">0</button>
                    <button class="btn btn-light" onclick="calcAppend('.')">.</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈùûË°®Á§∫„ÅÆ„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
    <input type="file" id="uploadQuizFile" accept="application/json" class="d-none">
    <input type="file" id="uploadVideoFile" accept="application/json" class="d-none">

    <!-- „É¢„Éº„ÉÄ„É´Áæ§ -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ÂïèÈ°åÂ±•Ê≠¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-1">
                    <div id="historyContainer" class="table-responsive"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="videoHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ÂãïÁîªÂ±•Ê≠¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-bordered table-striped mb-0" style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>ÂãïÁîª</th>
                                <th>ÂõûÊï∞</th>
                                <th>ÊúÄÁµÇ</th>
                            </tr>
                        </thead>
                        <tbody id="video-history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ÁµêÊûú</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center fs-5" id="resultContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂãïÁîªÁî®„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered">
            <div class="modal-content text-bg-dark border-0">
                <div class="modal-header border-0 pb-0 flex-shrink-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div
                    class="modal-body p-0 d-flex flex-column align-items-center justify-content-center overflow-hidden flex-grow-1">
                    <video id="modalVideo" controls autoplay></video>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const qFrame = document.getElementById("questionFrame");
        const aFrame = document.getElementById("answerFrame");
        const titleEl = document.getElementById("currentTitle");
        const titleStatSpan = document.getElementById("titleQuizStat");
        const historyContainer = document.getElementById("historyContainer");
        const offcanvasEl = document.getElementById("offcanvasMenu");
        let offcanvasInstance;

        let clickedOnce = false;
        let timerInterval = null;
        let elapsedSeconds = 0;

        document.addEventListener("DOMContentLoaded", () => {
            offcanvasInstance = new bootstrap.Offcanvas(offcanvasEl);

            fetch("data.json")
                .then(r => r.json())
                .then(data => buildMenu(data))
                .catch(err => {
                    document.getElementById("questionList").innerHTML = `<div class="text-danger">„Ç®„É©„Éº: ${err.message}</div>`;
                });
        });

        // ÈõªÂçì„É≠„Ç∏„ÉÉ„ÇØ
        const calcDisplay = document.getElementById("calcDisplay");
        function calcAppend(val) {
            if (calcDisplay.value === "0" && val !== ".") calcDisplay.value = val;
            else calcDisplay.value += val;
        }
        function calcClear() { calcDisplay.value = "0"; }
        function calcBack() {
            calcDisplay.value = calcDisplay.value.slice(0, -1);
            if (calcDisplay.value === "") calcDisplay.value = "0";
        }
        function calcEqual() {
            try {
                const expr = calcDisplay.value.replace(/[^0-9+\-*/.]/g, "");
                calcDisplay.value = eval(expr);
            } catch (e) {
                calcDisplay.value = "Error";
            }
        }

        function buildMenu(data) {
            const list = document.getElementById("questionList");
            list.innerHTML = "";

            for (const [folder, items] of Object.entries(data)) {
                const section = document.createElement("div");
                section.className = "mb-3";

                const titleWrapper = document.createElement("div");
                titleWrapper.className = "folder-title d-flex justify-content-between align-items-center mb-2";
                titleWrapper.innerHTML = `<span>${folder}</span>`;

                let firstVideo = (items || []).find(f => typeof f === "string" && f.toLowerCase().endsWith(".mp4"));
                if (firstVideo) {
                    const vBtn = document.createElement("button");
                    vBtn.className = "btn btn-sm btn-outline-primary video-btn py-0";
                    vBtn.dataset.video = "data/" + firstVideo;
                    vBtn.textContent = "ÂãïÁîª";
                    vBtn.onclick = (e) => { e.stopPropagation(); showVideoModal("data/" + firstVideo); };
                    titleWrapper.appendChild(vBtn);
                }
                section.appendChild(titleWrapper);

                const btnGroup = document.createElement("div");
                btnGroup.className = "d-grid gap-1";

                (items || []).forEach(item => {
                    if (typeof item === "string" && !item.toLowerCase().endsWith(".mp4")) {
                        const btn = document.createElement("button");
                        btn.className = "btn btn-light btn-sm text-start border";
                        btn.dataset.file = "data/" + item;
                        btn.textContent = item.split("/").pop().replace(".html", "");
                        btn.onclick = () => {
                            qFrame.src = btn.dataset.file;
                            aFrame.classList.add("d-none");
                            qFrame.classList.remove("d-none");
                            titleEl.textContent = btn.textContent;
                            clickedOnce = false;

                            if (window.innerWidth < 992) {
                                offcanvasInstance.hide();
                            }
                        };
                        btnGroup.appendChild(btn);
                    }
                });

                section.appendChild(btnGroup);
                list.appendChild(section);
            }
            updateMenuHighlight();
            updateVideoButtons();
            updateMenuBookmarks();
        }

        function loadVideoHistory() { return JSON.parse(localStorage.getItem("video_history") || "{}"); }
        function saveVideoHistory(p) {
            const d = loadVideoHistory();
            if (!d[p]) d[p] = { watched: true, count: 0, lastWatched: "" };
            d[p].watched = true; d[p].count++; d[p].lastWatched = new Date().toLocaleString("ja-JP");
            localStorage.setItem("video_history", JSON.stringify(d));
        }
        function updateVideoButtons() {
            const h = loadVideoHistory();
            document.querySelectorAll(".video-btn").forEach(b => {
                if (h[b.dataset.video]?.watched) { b.classList.remove("btn-outline-primary"); b.classList.add("btn-primary"); }
            });
        }

        function showVideoModal(src) {
            saveVideoHistory(src);
            updateVideoButtons();
            let m = document.getElementById("videoModal");
            m.querySelector("video").src = src;
            new bootstrap.Modal(m).show();

            if (!m.dataset.listenerAdded) {
                m.addEventListener("hidden.bs.modal", () => {
                    const v = m.querySelector("video");
                    v.pause();
                    v.src = "";
                });
                m.dataset.listenerAdded = "true";
            }
        }

        function loadResults() { return JSON.parse(localStorage.getItem("quiz_results") || "{}"); }
        function saveResult(file, correct, wrong, timeSec) {
            const d = loadResults();
            if (!d[file]) d[file] = [];
            d[file].unshift({ correct, wrong, rate: Math.round((correct / (correct + wrong || 1)) * 100), time: timeSec, date: new Date().toLocaleString("ja-JP") });
            if (d[file].length > 10) d[file] = d[file].slice(0, 10);
            localStorage.setItem("quiz_results", JSON.stringify(d));
            updateMenuHighlight();
        }

        function updateMenuHighlight() {
            const d = loadResults();
            document.querySelectorAll("#questionList button[data-file]").forEach(b => {
                const f = b.dataset.file.split("/").pop();
                const r = d[f] || [];
                if (r.some(x => x.rate === 100)) b.style.color = "blue";
                else if (r[0]?.wrong > 0) b.style.color = "red";
                else b.style.color = "";
            });
        }

        qFrame.addEventListener("load", () => {
            const doc = qFrame.contentDocument; if (!doc) return;
            const pn = doc.querySelector(".page-number"); if (pn) pn.style.display = "none";
            const btn = doc.querySelector("#btn_Answer, #btn_Answer_Text"); if (!btn) return;

            hideLabels(doc); startTimer(doc);
            btn.textContent = "ÂõûÁ≠î"; clickedOnce = false;

            const qFile = qFrame.src.split("/").pop();
            const stats = getQuizStats(qFile);
            titleStatSpan.textContent = stats.count > 0 ? `ÂõûÁ≠î: ${stats.count}Âõû / Âπ≥Âùá: ${stats.avgRate}%` : "Êú™ÂõûÁ≠î";

            const bookmarkBtn = doc.getElementById("btnElearningBookmark");
            if (bookmarkBtn) {
                const bms = loadBookmarks();
                bookmarkBtn.style.backgroundColor = bms.includes(qFile) ? "yellow" : "";
                bookmarkBtn.onclick = () => {
                    let cur = loadBookmarks();
                    if (cur.includes(qFile)) { cur = cur.filter(x => x !== qFile); bookmarkBtn.style.backgroundColor = ""; }
                    else { cur.push(qFile); bookmarkBtn.style.backgroundColor = "yellow"; }
                    saveBookmarks(cur); updateMenuBookmarks();
                };
            }

            btn.onclick = async () => {
                const aFile = qFrame.src.replace(".html", "A.html");
                if (!clickedOnce) {
                    stopTimer();
                    try {
                        const res = await fetch(aFile); const html = await res.text();
                        const ansDoc = new DOMParser().parseFromString(html, "text/html");
                        let c = 0, w = 0;
                        doc.querySelectorAll("input[id],select[id]").forEach(el => {
                            const cel = ansDoc.querySelector(`#${el.id}`); if (!cel) return;
                            const v = (el.value || "").replace(/,/g, "").trim(), target = (cel.value || "").replace(/,/g, "").trim();
                            if (v === "" && target === "") return;
                            if (v === target) { el.style.backgroundColor = "rgba(0,255,0,0.2)"; c++; }
                            else { el.style.backgroundColor = "rgba(255,0,0,0.2)"; w++; }
                        });
                        const rContent = document.getElementById("resultContent");
                        rContent.innerHTML = `<b class="text-success">Ê≠£Ëß£:${c}</b> / <b class="text-danger">‰∏çÊ≠£Ëß£:${w}</b><br><small>ÊôÇÈñì:${formatTime(elapsedSeconds)}</small>`;
                        new bootstrap.Modal(document.getElementById("resultModal")).show();
                        saveResult(qFile, c, w, elapsedSeconds);
                        btn.textContent = "Ëß£Ë™¨"; clickedOnce = true;
                    } catch (e) { alert("Ê≠£Ëß£ÂèñÂæóÂ§±Êïó: " + e); }
                } else {
                    aFrame.src = aFile; aFrame.onload = () => hideLabels(aFrame.contentDocument, true);
                    qFrame.classList.add("d-none"); aFrame.classList.remove("d-none");
                }
            };
        });

        function hideLabels(doc, isA = false) {
            ["p.cancel#btn_Cancel", "div.result"].forEach(s => { const x = doc.querySelector(s); if (x) x.style.display = "none"; });
            if (isA) { const a = doc.querySelector("h2#btn_Answer"); if (a) a.style.display = "none"; }
        }

        function startTimer(doc) {
            const t = doc.getElementById("v_time_all"); if (!t) return;
            stopTimer(); elapsedSeconds = 0;
            const f = () => t.textContent = formatTime(elapsedSeconds);
            f(); timerInterval = setInterval(() => { elapsedSeconds++; f(); }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function formatTime(s) { return `${Math.floor(s / 60)}ÂàÜ${String(s % 60).padStart(2, "0")}Áßí`; }

        function loadBookmarks() { return JSON.parse(localStorage.getItem("quiz_bookmarks") || "[]"); }
        function saveBookmarks(b) { localStorage.setItem("quiz_bookmarks", JSON.stringify(b)); }
        function updateMenuBookmarks() {
            const bms = loadBookmarks();
            document.querySelectorAll("#questionList button[data-file]").forEach(b => {
                const f = b.dataset.file.split("/").pop();
                b.style.backgroundColor = bms.includes(f) ? "yellow" : "";
            });
        }
        function getQuizStats(f) {
            const d = loadResults()[f] || [];
            if (!d.length) return { count: 0, avgRate: 0 };
            return { count: d.length, avgRate: Math.round(d.reduce((s, r) => s + r.rate, 0) / d.length) };
        }

        document.getElementById("historyModal").addEventListener("show.bs.modal", () => {
            const d = loadResults();
            let h = '<table class="table table-sm table-condensed" style="font-size:0.75rem"><thead><tr><th>ÂïèÈ°å</th><th>Áéá</th><th>ÊôÇÈñì</th><th>Êó•</th></tr></thead><tbody>';
            for (const [f, recs] of Object.entries(d)) {
                recs.forEach(r => { h += `<tr><td>${f.replace('.html', '')}</td><td>${r.rate}%</td><td>${formatTime(r.time)}</td><td>${r.date.split(' ')[0]}</td></tr>`; });
            }
            document.getElementById("historyContainer").innerHTML = h + '</tbody></table>';
        });
        document.getElementById("videoHistoryModal").addEventListener("show.bs.modal", () => {
            const h = loadVideoHistory();
            let row = "";
            for (let t in h) { row += `<tr><td>${t}</td><td>${h[t].count}</td><td>${h[t].lastWatched.split(' ')[0]}</td></tr>`; }
            document.getElementById("video-history-body").innerHTML = row;
        });

        document.getElementById("downloadQuizBtn").onclick = () => downloadJSON("quiz_results.json", loadResults());
        document.getElementById("downloadVideoBtn").onclick = () => downloadJSON("video_history.json", loadVideoHistory());
        function downloadJSON(n, d) {
            const b = new Blob([JSON.stringify(d, null, 2)], { type: "application/json" });
            const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = n; a.click();
        }
        document.getElementById("uploadQuizBtn").onclick = () => document.getElementById("uploadQuizFile").click();
        document.getElementById("uploadVideoBtn").onclick = () => document.getElementById("uploadVideoFile").click();
        document.getElementById("uploadQuizFile").onchange = (e) => handleUpload(e.target, "quiz_results", updateMenuHighlight);
        document.getElementById("uploadVideoFile").onchange = (e) => handleUpload(e.target, "video_history", updateVideoButtons);
        async function handleUpload(el, k, cb) {
            const f = el.files[0]; if (!f) return;
            const j = JSON.parse(await f.text()); localStorage.setItem(k, JSON.stringify(j));
            if (cb) cb(); alert("ÂÆå‰∫Ü"); el.value = "";
        }

        document.getElementById("reloadBtn").onclick = () => location.reload();
        document.getElementById("clearBtn").onclick = () => {
            const doc = qFrame.contentDocument; if (!doc) return;
            doc.querySelectorAll("input, select").forEach(el => { el.value = ""; el.style.backgroundColor = ""; });
        };
    </script>
</body>

</html>